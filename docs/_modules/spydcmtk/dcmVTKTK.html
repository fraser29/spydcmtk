

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spydcmtk.dcmVTKTK &mdash; spydcmtk 1.1.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=a48ae3df"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            spydcmtk
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/introduction.html">spydcmtk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/version-history.html">Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/dicom-conversion.html">DICOM CONVERSION</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">spydcmtk</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spydcmtk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spydcmtk.dcmVTKTK</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spydcmtk.dcmVTKTK</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on MArch 2023 (rewrite from old module - remove reliance on VTKDICOM)</span>

<span class="sd">@author: fraser</span>

<span class="sd">Dicom to VTK conversion toolkit</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">pydicom</span> <span class="k">as</span> <span class="nn">dicom</span>
<span class="kn">from</span> <span class="nn">pydicom.sr.codedict</span> <span class="kn">import</span> <span class="n">codes</span>
<span class="kn">from</span> <span class="nn">pydicom.uid</span> <span class="kn">import</span> <span class="n">generate_uid</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">highdicom.seg.content</span> <span class="kn">import</span> <span class="n">SegmentDescription</span>
    <span class="kn">from</span> <span class="nn">highdicom.seg.enum</span> <span class="kn">import</span> <span class="n">SegmentAlgorithmTypeValues</span><span class="p">,</span> <span class="n">SegmentationTypeValues</span>
    <span class="kn">from</span> <span class="nn">highdicom.content</span> <span class="kn">import</span> <span class="n">AlgorithmIdentificationSequence</span>
    <span class="kn">from</span> <span class="nn">highdicom.seg.sop</span> <span class="kn">import</span> <span class="n">Segmentation</span>
    <span class="n">HIGHDCM</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HIGHDCM</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">from</span> <span class="nn">vtk.util</span> <span class="kn">import</span> <span class="n">numpy_support</span> <span class="c1"># type: ignore</span>

<span class="kn">import</span> <span class="nn">spydcmtk.dcmTools</span> <span class="k">as</span> <span class="nn">dcmTools</span>
<span class="kn">from</span> <span class="nn">ngawari</span> <span class="kn">import</span> <span class="n">fIO</span>
<span class="kn">from</span> <span class="nn">ngawari</span> <span class="kn">import</span> <span class="n">ftk</span>
<span class="kn">from</span> <span class="nn">ngawari</span> <span class="kn">import</span> <span class="n">vtkfilters</span>


<span class="n">mm_to_m</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">cm_to_m</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">ms_to_s</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">m_to_mm</span> <span class="o">=</span> <span class="mf">1000.0</span>

<span class="c1"># =========================================================================</span>
<span class="c1">## PATIENT MATRIX HELPER</span>
<span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="PatientMeta">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta">[docs]</a>
<span class="k">class</span> <span class="nc">PatientMeta</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class that manages spatial / geometric information for DICOM and VTK conversion</span>
<span class="sd">    </span>
<span class="sd">    _meta keys:</span>
<span class="sd">    &#39;ImagePositionPatient&#39;, &#39;PixelSpacing&#39;, &#39;ImageOrientationPatient&#39;, &#39;SliceVector&#39;, &#39;SliceThickness&#39;, &#39;SliceLocation0&#39;, &#39;SpacingBetweenSlices&#39;, &#39;Dimensions&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;SI&quot;</span>
        <span class="c1"># Minimal defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="s1">&#39;PixelSpacing&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
            <span class="s1">&#39;SliceThickness&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="s1">&#39;SliceLocation0&#39;</span><span class="p">:</span> <span class="mf">0.0</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">)</span>

    <span class="c1"># Properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PixelSpacing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ImagePositionPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ImageOrientationPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SliceVector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceVector&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SpacingBetweenSlices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceThickness&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SliceThickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceThickness&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SliceLocation0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceLocation0&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImagePositionPatient</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;SpacingBetweenSlices&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceThickness&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PatientPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PatientPosition&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;HFS&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Times&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>

    <span class="c1"># ------------------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="PatientMeta.initFromDictionary">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.initFromDictionary">[docs]</a>
    <span class="k">def</span> <span class="nf">initFromDictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metaDict</span><span class="p">):</span>
        <span class="c1"># Force required keys</span>
        <span class="k">if</span> <span class="s1">&#39;PixelSpacing&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metaDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Spacing&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metaDict</span><span class="p">:</span>
                <span class="n">metaDict</span><span class="p">[</span><span class="s1">&#39;Spacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ImagePositionPatient&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metaDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Origin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metaDict</span><span class="p">:</span>
                <span class="n">metaDict</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ImageOrientationPatient&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metaDict</span><span class="p">:</span>
            <span class="n">metaDict</span><span class="p">[</span><span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metaDict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metaVTI2DCMConversion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMatrix</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__metaVTI2DCMConversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Spacing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Spacing&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Spacing&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;SliceThickness&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceThickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Spacing&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;SpacingBetweenSlices&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;SliceThickness&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>

<div class="viewcode-block" id="PatientMeta.initFromDicomSeries">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.initFromDicomSeries">[docs]</a>
    <span class="k">def</span> <span class="nf">initFromDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicomSeries</span><span class="p">):</span>
        <span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;Rows&#39;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;Columns&#39;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dicomSeries</span><span class="o">.</span><span class="n">getNumberOfSlicesPerVolume</span><span class="p">())</span>
        <span class="n">dicomSeries</span><span class="o">.</span><span class="n">sortBySlice_InstanceNumber</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getNumberOfTimeSteps</span><span class="p">()</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">iA</span> <span class="o">=</span> <span class="n">dicomSeries</span><span class="p">[</span><span class="n">c0</span><span class="p">]</span><span class="o">.</span><span class="n">pixel_array</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iA</span>
                <span class="n">c0</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTemporalResolution</span><span class="p">()</span>
        <span class="n">ipp</span> <span class="o">=</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getImagePositionPatient_np</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sliceVec</span> <span class="o">=</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getSliceNormalVector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;PixelSpacing&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">dicomSeries</span><span class="o">.</span><span class="n">getDeltaRow</span><span class="p">()</span><span class="o">*</span><span class="n">mm_to_m</span><span class="p">,</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getDeltaCol</span><span class="p">()</span><span class="o">*</span><span class="n">mm_to_m</span><span class="p">],</span>
                    <span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">:</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getDeltaSlice</span><span class="p">()</span><span class="o">*</span><span class="n">mm_to_m</span><span class="p">,</span>
                    <span class="s1">&#39;SliceThickness&#39;</span><span class="p">:</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;SliceThickness&#39;</span><span class="p">,</span> <span class="n">convertToType</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="n">dicomSeries</span><span class="o">.</span><span class="n">getDeltaSlice</span><span class="p">())</span><span class="o">*</span><span class="n">mm_to_m</span><span class="p">,</span>
                    <span class="s1">&#39;SliceLocation0&#39;</span><span class="p">:</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;SliceLocation&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">convertToType</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">*</span><span class="n">mm_to_m</span><span class="p">,</span>
                    <span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">mm_to_m</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ipp</span><span class="p">],</span> 
                    <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">:</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">),</span> 
                    <span class="s1">&#39;PatientPosition&#39;</span><span class="p">:</span> <span class="n">dicomSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;PatientPosition&#39;</span><span class="p">),</span> 
                    <span class="s1">&#39;Times&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">dt</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">ms_to_s</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)],</span> <span class="c1"># ms to s</span>
                    <span class="s1">&#39;Dimensions&#39;</span><span class="p">:</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="s1">&#39;SliceVector&#39;</span><span class="p">:</span> <span class="n">sliceVec</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMatrix</span><span class="p">()</span></div>


<div class="viewcode-block" id="PatientMeta.initFromVTI">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.initFromVTI">[docs]</a>
    <span class="k">def</span> <span class="nf">initFromVTI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtiObj</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dz</span> <span class="o">=</span> <span class="n">vtiObj</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>
        <span class="n">oo</span> <span class="o">=</span> <span class="n">vtiObj</span><span class="o">.</span><span class="n">GetOrigin</span><span class="p">()</span>
        <span class="c1"># 1st option from meta, then field data then default</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iop</span> <span class="o">=</span> <span class="n">vtkfilters</span><span class="o">.</span><span class="n">getFieldData</span><span class="p">(</span><span class="n">vtiObj</span><span class="p">,</span> <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">iop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sliceVec</span> <span class="o">=</span> <span class="n">vtkfilters</span><span class="o">.</span><span class="n">getFieldData</span><span class="p">(</span><span class="n">vtiObj</span><span class="p">,</span> <span class="s1">&#39;SliceVector&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">sliceVec</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PixelSpacing&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">dy</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">,</span> <span class="n">dx</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">],</span>
                            <span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">scaleFactor</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oo</span><span class="p">],</span>
                            <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">:</span> <span class="n">iop</span><span class="p">,</span>
                            <span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">:</span> <span class="n">dz</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">,</span>
                            <span class="s1">&#39;SliceVector&#39;</span><span class="p">:</span> <span class="n">sliceVec</span><span class="p">,</span>
                            <span class="s1">&#39;Dimensions&#39;</span><span class="p">:</span> <span class="n">vtiObj</span><span class="o">.</span><span class="n">GetDimensions</span><span class="p">(),</span>
                            <span class="s1">&#39;SliceThickness&#39;</span><span class="p">:</span> <span class="n">dz</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">,</span>
                            <span class="s1">&#39;SliceLocation0&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMatrix</span><span class="p">()</span></div>


<div class="viewcode-block" id="PatientMeta.initFromDicomSeg">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.initFromDicomSeg">[docs]</a>
    <span class="k">def</span> <span class="nf">initFromDicomSeg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicomSeg</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span> <span class="c1"># TODO</span>
        <span class="k">pass</span></div>

        <span class="c1"># sliceThick = dicomSeg.SharedFunctionalGroupsSequence[0].PixelMeasuresSequence[0].SliceThickness</span>
        <span class="c1"># pixSpace = dicomSeg.SharedFunctionalGroupsSequence[0].PixelMeasuresSequence[0].PixelSpacing</span>
        <span class="c1"># ipp = [i.PlanePositionSequence[0].ImagePositionPatient for i in dicomSeg.PerFrameFunctionalGroupsSequence]</span>
        <span class="c1"># oo = np.array(ipp[0])</span>
        <span class="c1"># normalVector = np.array(ipp[-1]) - oo </span>
        <span class="c1"># normalVector = normalVector / np.linalg.norm(normalVector)</span>
        <span class="c1"># oo = dicomSeg.PerFrameFunctionalGroupsSequence[0].PlanePositionSequence[0].ImagePositionPatient</span>
        <span class="c1"># iop = dicomSeg.SharedFunctionalGroupsSequence[0].PlaneOrientationSequence[0].ImageOrientationPatient</span>
        <span class="c1"># seg_data = dicomSeg.pixel_array</span>
        <span class="c1"># seg_data = np.transpose(seg_data, axes=[2,1,0])</span>
        <span class="c1"># self._meta = {&quot;ImagePositionPatient&quot;: [oo[0]*scaleFactor, oo[1]*scaleFactor, oo[2]*scaleFactor], </span>
        <span class="c1">#         &quot;PixelSpacing&quot;: [pixSpace[0]*scaleFactor, pixSpace[1]*scaleFactor],</span>
        <span class="c1">#         &quot;SliceThickness&quot;: sliceThick*scaleFactor,</span>
        <span class="c1">#         &quot;SpacingBetweenSlices&quot;: sliceThick*scaleFactor,</span>
        <span class="c1">#         &quot;Dimensions&quot;: seg_data.shape,</span>
        <span class="c1">#         &quot;ImageOrientationPatient&quot;: iop, </span>
        <span class="c1">#         &quot;SliceVector&quot;: normalVector   </span>
        <span class="c1">#         }</span>
        <span class="c1"># self._updateMatrix()</span>

    <span class="k">def</span> <span class="nf">_updateMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildImage2PatientCoordinateMatrix</span><span class="p">()</span>

<div class="viewcode-block" id="PatientMeta.buildImage2PatientCoordinateMatrix">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.buildImage2PatientCoordinateMatrix">[docs]</a>
    <span class="k">def</span> <span class="nf">buildImage2PatientCoordinateMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dr</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spacing</span>
        <span class="n">oo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImagePositionPatient</span>
        <span class="n">iop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ImageOrientationPatient</span><span class="p">)</span>
        <span class="n">vZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SliceVector</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="n">iop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">dr</span><span class="p">,</span> <span class="n">vZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
            <span class="p">[</span><span class="n">iop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="n">iop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">dr</span><span class="p">,</span> <span class="n">vZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">oo</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> 
            <span class="p">[</span><span class="n">iop</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="n">iop</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">dr</span><span class="p">,</span> <span class="n">vZ</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">oo</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> 
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">matrix</span></div>


<div class="viewcode-block" id="PatientMeta.getMatrix">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.getMatrix">[docs]</a>
    <span class="k">def</span> <span class="nf">getMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span></div>


<div class="viewcode-block" id="PatientMeta.getMetaForVTK">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.getMetaForVTK">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaForVTK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Origin</span><span class="p">,</span>
            <span class="s1">&#39;Spacing&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spacing</span><span class="p">,</span>
            <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageOrientationPatient</span><span class="p">,</span>
            <span class="s1">&#39;SliceVector&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SliceVector</span><span class="p">,</span>
            <span class="s1">&#39;Dimensions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PatientMeta.getMetaForDICOM">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.getMetaForDICOM">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaForDICOM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary with the meta data for DICOM</span>
<span class="sd">        Keys are: </span>
<span class="sd">        &#39;ImagePositionPatient&#39;, &#39;PixelSpacing&#39;, &#39;ImageOrientationPatient&#39;, &#39;SliceVector&#39;, &#39;SliceThickness&#39;, &#39;SliceLocation0&#39;, &#39;SpacingBetweenSlices&#39;</span>
<span class="sd">        All in mm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">m_to_mm</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImagePositionPatient</span><span class="p">]),</span>
            <span class="s1">&#39;PixelSpacing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">m_to_mm</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">]),</span>
            <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ImageOrientationPatient</span><span class="p">,</span>
            <span class="s1">&#39;SliceVector&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SliceVector</span><span class="p">,</span>
            <span class="s1">&#39;SliceThickness&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SliceThickness</span><span class="o">*</span><span class="n">m_to_mm</span><span class="p">,</span>
            <span class="s1">&#39;SliceLocation0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SliceLocation0</span><span class="o">*</span><span class="n">m_to_mm</span><span class="p">,</span>
            <span class="s1">&#39;SpacingBetweenSlices&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SpacingBetweenSlices</span><span class="o">*</span><span class="n">m_to_mm</span>
        <span class="p">}</span>   </div>


<div class="viewcode-block" id="PatientMeta.imageToPatientCoordinates">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.imageToPatientCoordinates">[docs]</a>
    <span class="k">def</span> <span class="nf">imageToPatientCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageCoords</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">imageCoords</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">homogeneous_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">imageCoords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,))))</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span> <span class="o">@</span> <span class="n">homogeneous_coords</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">homogeneous_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">imageCoords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">imageCoords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span> <span class="o">@</span> <span class="n">homogeneous_coords</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span></div>


<div class="viewcode-block" id="PatientMeta.patientToImageCoordinates">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.patientToImageCoordinates">[docs]</a>
    <span class="k">def</span> <span class="nf">patientToImageCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patientCoords</span><span class="p">):</span>
        <span class="n">homogeneous_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">patientCoords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">patientCoords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span><span class="p">)</span> <span class="o">@</span> <span class="n">homogeneous_coords</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span></div>


<div class="viewcode-block" id="PatientMeta.getVtkMatrix">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.getVtkMatrix">[docs]</a>
    <span class="k">def</span> <span class="nf">getVtkMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtkMatrix</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">vtkMatrix</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">vtkMatrix</span></div>


<div class="viewcode-block" id="PatientMeta.getVTKTransform">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.getVTKTransform">[docs]</a>
    <span class="k">def</span> <span class="nf">getVTKTransform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtkMatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVtkMatrix</span><span class="p">()</span>
        <span class="n">vtkTransform</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
        <span class="n">vtkTransform</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">vtkMatrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vtkTransform</span></div>


<div class="viewcode-block" id="PatientMeta.transformVTKData">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.transformVTKData">[docs]</a>
    <span class="k">def</span> <span class="nf">transformVTKData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtkData</span><span class="p">):</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVTKTransform</span><span class="p">()</span>
        <span class="n">transformFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransformFilter</span><span class="p">()</span>
        <span class="n">transformFilter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">vtkData</span><span class="p">)</span>
        <span class="n">transformFilter</span><span class="o">.</span><span class="n">SetTransform</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">transformFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">transformFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span></div>


<div class="viewcode-block" id="PatientMeta.getMeta">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.getMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">getMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span></div>


<div class="viewcode-block" id="PatientMeta.setMeta">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.setMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">setMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMatrix</span><span class="p">()</span></div>


<div class="viewcode-block" id="PatientMeta.updateFromMeta">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.PatientMeta.updateFromMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">updateFromMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metaDict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metaDict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMatrix</span><span class="p">()</span></div>
</div>



<span class="c1"># ===================================================================================================</span>
<span class="c1"># EXPOSED METHODS</span>
<span class="c1"># ===================================================================================================</span>

<div class="viewcode-block" id="arrToVTI">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.arrToVTI">[docs]</a>
<span class="k">def</span> <span class="nf">arrToVTI</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
            <span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="p">,</span> 
            <span class="n">ds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dicom</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">TRUE_ORIENTATION</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert array (+meta) to VTI dict (keys=times, values=VTI volumes). </span>

<span class="sd">    Args:</span>
<span class="sd">        arr (np.array): Array of pixel data, shape: nR,nC,nSlice,nTime</span>
<span class="sd">        patientMeta (PatientMatrix): PatientMatrix object containing meta to be added as Field data</span>
<span class="sd">        ds (pydicom dataset [optional]): pydicom dataset to use to add dicom tags as field data</span>
<span class="sd">        TRUE_ORIENTATION (bool [False]) : Boolean to force accurate spatial location of image data.</span>
<span class="sd">                                NOTE: this uses resampling from VTS data so output VTI will have different dimensions. </span>
<span class="sd">        outputPath (str [None]): Save as go, then rename at end - RAM friendly</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        vtiDict</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If VTK import not available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">vtkDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,:,:,</span><span class="n">k1</span><span class="p">]</span>
        <span class="c1">###        </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thisTime</span> <span class="o">=</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Times</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">thisTime</span> <span class="o">=</span> <span class="n">k1</span>
        <span class="k">if</span> <span class="n">TRUE_ORIENTATION</span><span class="p">:</span>
            <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">vts_data</span> <span class="o">=</span> <span class="n">__arr3ToVTS</span><span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">thisTime</span><span class="o">=</span><span class="n">thisTime</span><span class="p">)</span>
            <span class="n">newImg</span> <span class="o">=</span> <span class="n">filterResampleToImage</span><span class="p">(</span><span class="n">vts_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">patientMeta</span><span class="o">.</span><span class="n">Spacing</span><span class="p">))</span>
            <span class="n">vtkfilters</span><span class="o">.</span><span class="n">delArraysExcept</span><span class="p">(</span><span class="n">newImg</span><span class="p">,</span> <span class="p">[],</span> <span class="n">pointData</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">vtkfilters</span><span class="o">.</span><span class="n">delArraysExcept</span><span class="p">(</span><span class="n">newImg</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PixelData&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A3 = np.swapaxes(A3, 0, 1)</span>
            <span class="n">newImg</span> <span class="o">=</span> <span class="n">_arrToImagedata</span><span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addFieldDataFromDcmDataSet</span><span class="p">(</span><span class="n">newImg</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SliceVector&quot;</span><span class="p">:</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">SliceVector</span><span class="p">,</span>
                                                                <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="n">thisTime</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">outputPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newImg</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">writeVTKFile</span><span class="p">(</span><span class="n">newImg</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">k1</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.vti&quot;</span><span class="p">))</span>
        <span class="n">vtkDict</span><span class="p">[</span><span class="n">thisTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">newImg</span>
    <span class="k">return</span> <span class="n">vtkDict</span></div>


<span class="k">def</span> <span class="nf">_arrToImagedata</span><span class="p">(</span><span class="n">A3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">:</span>
    <span class="n">newImg</span> <span class="o">=</span> <span class="n">_buildVTIImage</span><span class="p">(</span><span class="n">patientMeta</span><span class="p">)</span>
    <span class="n">npArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">A3</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">aArray</span> <span class="o">=</span> <span class="n">numpy_support</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">npArray</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">aArray</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s1">&#39;PixelData&#39;</span><span class="p">)</span>
    <span class="n">newImg</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">aArray</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newImg</span>

<span class="k">def</span> <span class="nf">_buildVTIImage</span><span class="p">(</span><span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">patientMeta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">patientMeta</span> <span class="o">=</span> <span class="n">PatientMeta</span><span class="p">()</span>
    <span class="n">vti_image</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">()</span>
    <span class="n">vti_image</span><span class="o">.</span><span class="n">SetSpacing</span><span class="p">(</span><span class="n">patientMeta</span><span class="o">.</span><span class="n">Spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">vti_image</span><span class="o">.</span><span class="n">SetOrigin</span><span class="p">(</span><span class="n">patientMeta</span><span class="o">.</span><span class="n">Origin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Origin</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">vti_image</span><span class="o">.</span><span class="n">SetDimensions</span><span class="p">(</span><span class="n">patientMeta</span><span class="o">.</span><span class="n">Dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vti_image</span>


<span class="k">def</span> <span class="nf">__arr3ToVTS</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dicom</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thisTime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStructuredGrid</span><span class="p">:</span>
    <span class="n">dummyPatientMeta</span> <span class="o">=</span> <span class="n">PatientMeta</span><span class="p">()</span>
    <span class="n">dummyPatientMeta</span><span class="o">.</span><span class="n">setMeta</span><span class="p">(</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">_arrToImagedata</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">patientMeta</span><span class="o">=</span><span class="n">dummyPatientMeta</span><span class="p">)</span> <span class="c1"># No info here, let the transform take care of it</span>
    <span class="n">vts_data</span> <span class="o">=</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">transformVTKData</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">addFieldDataFromDcmDataSet</span><span class="p">(</span><span class="n">vts_data</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SliceVector&quot;</span><span class="p">:</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">SliceVector</span><span class="p">,</span>
                                                                <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="n">thisTime</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">vts_data</span>


<div class="viewcode-block" id="arrToVTS">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.arrToVTS">[docs]</a>
<span class="k">def</span> <span class="nf">arrToVTS</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
            <span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="p">,</span> 
            <span class="n">ds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dicom</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStructuredGrid</span><span class="p">]:</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">vtkDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,:,:,</span><span class="n">k1</span><span class="p">]</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thisTime</span> <span class="o">=</span> <span class="n">patientMeta</span><span class="o">.</span><span class="n">Times</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">thisTime</span> <span class="o">=</span> <span class="n">k1</span>
        <span class="n">vts_data</span> <span class="o">=</span> <span class="n">__arr3ToVTS</span><span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">thisTime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outputPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vts_data</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">writeVTKFile</span><span class="p">(</span><span class="n">vts_data</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">k1</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.vts&quot;</span><span class="p">))</span>
        <span class="n">vtkDict</span><span class="p">[</span><span class="n">thisTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">vts_data</span>
    <span class="k">return</span> <span class="n">vtkDict</span></div>



<div class="viewcode-block" id="writeArrToVTI">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.writeArrToVTI">[docs]</a>
<span class="k">def</span> <span class="nf">writeArrToVTI</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="p">,</span> <span class="n">filePrefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dicom</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">TRUE_ORIENTATION</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Will write a VTI file(s) from arr (if np.ndim(arr)=4 write vti files + pvd file)</span>

<span class="sd">    Args:</span>
<span class="sd">        arr (np.array): Array of pixel data, shape: nR,nC,nSlice,nTime</span>
<span class="sd">        patientMeta (PatientMatrix): PatientMatrix object containing meta to be added as Field data</span>
<span class="sd">        filePrefix (str): File name prefix (if nTime&gt;1 then named &#39;{fileprefix}_{timeID:05d}.vti)</span>
<span class="sd">        outputPath (str): Output path (if nTime &gt; 1 then &#39;{fileprefix}.pvd written to outputPath and sub-directory holds `*.vti` files)</span>
<span class="sd">        ds (pydicom dataset [optional]): pydicom dataset to use to add dicom tags as field data</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If VTK import not available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vtkDict</span> <span class="o">=</span> <span class="n">arrToVTI</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">patientMeta</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">TRUE_ORIENTATION</span><span class="o">=</span><span class="n">TRUE_ORIENTATION</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">writeVTIDict</span><span class="p">(</span><span class="n">vtkDict</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">,</span> <span class="n">filePrefix</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeVTIDict">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.writeVTIDict">[docs]</a>
<span class="k">def</span> <span class="nf">writeVTIDict</span><span class="p">(</span><span class="n">vtiDict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">],</span> <span class="n">outputPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filePrefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vtiDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fIO</span><span class="o">.</span><span class="n">writeVTK_PVD_Dict</span><span class="p">(</span><span class="n">vtiDict</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">,</span> <span class="n">filePrefix</span><span class="p">,</span> <span class="s1">&#39;vti&#39;</span><span class="p">,</span> <span class="n">BUILD_SUBDIR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fOut</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filePrefix</span><span class="si">}</span><span class="s1">.vti&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fIO</span><span class="o">.</span><span class="n">writeVTKFile</span><span class="p">(</span><span class="n">vtiDict</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">fOut</span><span class="p">)</span></div>


<div class="viewcode-block" id="scaleVTI">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.scaleVTI">[docs]</a>
<span class="k">def</span> <span class="nf">scaleVTI</span><span class="p">(</span><span class="n">vti_data</span><span class="p">:</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vti_data</span><span class="o">.</span><span class="n">SetOrigin</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">factor</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vti_data</span><span class="o">.</span><span class="n">GetOrigin</span><span class="p">()])</span>
    <span class="n">vti_data</span><span class="o">.</span><span class="n">SetSpacing</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">factor</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vti_data</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()])</span></div>


<div class="viewcode-block" id="filterResampleToImage">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.filterResampleToImage">[docs]</a>
<span class="k">def</span> <span class="nf">filterResampleToImage</span><span class="p">(</span><span class="n">vtsObj</span><span class="p">:</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStructuredGrid</span><span class="p">,</span> <span class="n">target_spacing</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStructuredGrid</span><span class="p">:</span>
    <span class="n">rif</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkResampleToImage</span><span class="p">()</span>
    <span class="n">rif</span><span class="o">.</span><span class="n">SetInputDataObject</span><span class="p">(</span><span class="n">vtsObj</span><span class="p">)</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">target_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">target_spacing</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_spacing</span><span class="p">,</span> <span class="n">target_spacing</span><span class="p">,</span> <span class="n">target_spacing</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">vtsObj</span><span class="o">.</span><span class="n">GetBounds</span><span class="p">()</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">target_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="nb">int</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">target_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="nb">int</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="n">target_spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="n">rif</span><span class="o">.</span><span class="n">SetSamplingDimensions</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">rif</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rif</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span></div>



<div class="viewcode-block" id="readImageStackToVTI">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.readImageStackToVTI">[docs]</a>
<span class="k">def</span> <span class="nf">readImageStackToVTI</span><span class="p">(</span><span class="n">imageFileNames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">patientMeta</span><span class="p">:</span> <span class="n">PatientMeta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arrayName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;PixelData&#39;</span><span class="p">,</span> <span class="n">CONVERT_TO_GREYSCALE</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">:</span>
    <span class="n">append_filter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageAppend</span><span class="p">()</span>
    <span class="n">append_filter</span><span class="o">.</span><span class="n">SetAppendAxis</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Combine images along the Z axis</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">imageFileNames</span><span class="p">:</span>
        <span class="n">thisImage</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">readVTKFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">append_filter</span><span class="o">.</span><span class="n">AddInputData</span><span class="p">(</span><span class="n">thisImage</span><span class="p">)</span>
    <span class="n">append_filter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">combinedImage</span> <span class="o">=</span> <span class="n">append_filter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">patientMeta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">patientMeta</span> <span class="o">=</span> <span class="n">PatientMeta</span><span class="p">()</span>
    <span class="n">combinedImage</span><span class="o">.</span><span class="n">SetOrigin</span><span class="p">(</span><span class="n">patientMeta</span><span class="o">.</span><span class="n">Origin</span><span class="p">)</span>
    <span class="n">combinedImage</span><span class="o">.</span><span class="n">SetSpacing</span><span class="p">(</span><span class="n">patientMeta</span><span class="o">.</span><span class="n">Spacing</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">vtkfilters</span><span class="o">.</span><span class="n">getScalarsAsNumpy</span><span class="p">(</span><span class="n">combinedImage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">CONVERT_TO_GREYSCALE</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vtkfilters</span><span class="o">.</span><span class="n">setArrayFromNumpy</span><span class="p">(</span><span class="n">combinedImage</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">arrayName</span><span class="p">,</span> <span class="n">SET_SCALAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vtkfilters</span><span class="o">.</span><span class="n">delArraysExcept</span><span class="p">(</span><span class="n">combinedImage</span><span class="p">,</span> <span class="p">[</span><span class="n">arrayName</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">combinedImage</span></div>



<div class="viewcode-block" id="mergePhaseSeries4D">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.mergePhaseSeries4D">[docs]</a>
<span class="k">def</span> <span class="nf">mergePhaseSeries4D</span><span class="p">(</span><span class="n">magPVD</span><span class="p">,</span> <span class="n">phasePVD_list</span><span class="p">,</span> <span class="n">outputPVDName</span><span class="p">,</span> <span class="n">phase_factors</span><span class="p">,</span> <span class="n">phase_offsets</span><span class="p">,</span> <span class="n">DEL_ORIGINAL</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># TODO Generalise for 2DPC also</span>
    <span class="n">rootDir</span><span class="p">,</span> <span class="n">fName</span><span class="p">,</span> <span class="n">extn</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">pvdGetDataFileRoot_Prefix_and_Ext</span><span class="p">(</span><span class="n">outputPVDName</span><span class="p">)</span>
    <span class="n">magFiles</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">readPVDFileName</span><span class="p">(</span><span class="n">magPVD</span><span class="p">)</span>
    <span class="n">phaseFiles_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">fIO</span><span class="o">.</span><span class="n">readPVDFileName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phasePVD_list</span><span class="p">]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">magFiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">outputFilesDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">iTime</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">iVTS</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">readVTKFile</span><span class="p">(</span><span class="n">magFiles</span><span class="p">[</span><span class="n">iTime</span><span class="p">])</span>
        <span class="n">thisVelArray</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">iPhase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phaseFiles_dicts</span><span class="p">):</span> 
            <span class="n">thisPhase_time</span> <span class="o">=</span> <span class="n">ftk</span><span class="o">.</span><span class="n">getClosestFloat</span><span class="p">(</span><span class="n">iTime</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">iPhase</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">thisPhase</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">readVTKFile</span><span class="p">(</span><span class="n">iPhase</span><span class="p">[</span><span class="n">thisPhase_time</span><span class="p">])</span>
            <span class="n">aName</span> <span class="o">=</span> <span class="n">vtkfilters</span><span class="o">.</span><span class="n">getScalarsArrayName</span><span class="p">(</span><span class="n">thisPhase</span><span class="p">)</span>
            <span class="n">thisVelArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtkfilters</span><span class="o">.</span><span class="n">getArrayAsNumpy</span><span class="p">(</span><span class="n">thisPhase</span><span class="p">,</span> <span class="n">aName</span><span class="p">)</span><span class="o">*</span><span class="n">phase_factors</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">+</span> <span class="n">phase_offsets</span><span class="p">[</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">thisVelArray_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thisVelArray</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">vtkfilters</span><span class="o">.</span><span class="n">setArrayFromNumpy</span><span class="p">(</span><span class="n">iVTS</span><span class="p">,</span> <span class="n">thisVelArray_</span><span class="p">,</span> <span class="s2">&quot;Vel&quot;</span><span class="p">,</span> <span class="n">SET_VECTOR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fOutTemp</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">writeVTKFile</span><span class="p">(</span><span class="n">iVTS</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rootDir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fName</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k1</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.WORKING.vts&quot;</span><span class="p">))</span>
        <span class="n">outputFilesDict</span><span class="p">[</span><span class="n">iTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">fOutTemp</span>
    <span class="n">pvdFileOut</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">writeVTK_PVD_Dict</span><span class="p">(</span><span class="n">outputFilesDict</span><span class="p">,</span> <span class="n">rootDir</span><span class="p">,</span> <span class="n">fName</span><span class="p">,</span> <span class="s2">&quot;vts&quot;</span><span class="p">,</span> <span class="n">BUILD_SUBDIR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># FIXME rename</span>
    <span class="k">if</span> <span class="n">DEL_ORIGINAL</span><span class="p">:</span>
        <span class="n">fIO</span><span class="o">.</span><span class="n">deleteFilesByPVD</span><span class="p">(</span><span class="n">magPVD</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iPhaseFile</span> <span class="ow">in</span> <span class="n">phasePVD_list</span><span class="p">:</span>
            <span class="n">fIO</span><span class="o">.</span><span class="n">deleteFilesByPVD</span><span class="p">(</span><span class="n">iPhaseFile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pvdFileOut</span></div>


<span class="c1"># =========================================================================</span>
<span class="c1"># =========================================================================</span>
<span class="c1">## DICOM-SEG</span>
<span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="array_to_DcmSeg">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.array_to_DcmSeg">[docs]</a>
<span class="k">def</span> <span class="nf">array_to_DcmSeg</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">source_dicom_ds_list</span><span class="p">,</span> <span class="n">dcmSegFileOut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">algorithm_identification</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HIGHDCM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Missing highdicom </span><span class="se">\n</span><span class="s2"> Please run: pip install highdicom&quot;</span><span class="p">)</span>
    <span class="n">fullLabelMap</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ushort</span><span class="p">)</span>
    <span class="n">sSeg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fullLabelMap</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)))</span>
    <span class="n">sSeg</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sSegDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">segID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sSeg</span><span class="p">):</span>
        <span class="n">sSegDict</span><span class="p">[</span><span class="n">k1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Segment</span><span class="si">{</span><span class="n">k1</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fullLabelMap</span><span class="p">[</span><span class="n">fullLabelMap</span><span class="o">==</span><span class="n">segID</span><span class="p">]</span> <span class="o">=</span> <span class="n">k1</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># Describe the algorithm that created the segmentation if not given</span>
    <span class="k">if</span> <span class="n">algorithm_identification</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">algorithm_identification</span> <span class="o">=</span> <span class="n">AlgorithmIdentificationSequence</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Spydcmtk&#39;</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
            <span class="n">family</span><span class="o">=</span><span class="n">codes</span><span class="o">.</span><span class="n">cid7162</span><span class="o">.</span><span class="n">ArtificialIntelligence</span>
        <span class="p">)</span>
    <span class="n">segDesc_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Describe the segment</span>
    <span class="k">for</span> <span class="n">segID</span><span class="p">,</span> <span class="n">segName</span> <span class="ow">in</span> <span class="n">sSegDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description_segment</span> <span class="o">=</span> <span class="n">SegmentDescription</span><span class="p">(</span>
            <span class="n">segment_number</span><span class="o">=</span><span class="n">segID</span><span class="p">,</span>
            <span class="n">segment_label</span><span class="o">=</span><span class="n">segName</span><span class="p">,</span>
            <span class="n">segmented_property_category</span><span class="o">=</span><span class="n">codes</span><span class="o">.</span><span class="n">cid7150</span><span class="o">.</span><span class="n">Tissue</span><span class="p">,</span>
            <span class="n">segmented_property_type</span><span class="o">=</span><span class="n">codes</span><span class="o">.</span><span class="n">cid7154</span><span class="o">.</span><span class="n">Kidney</span><span class="p">,</span>
            <span class="n">algorithm_type</span><span class="o">=</span><span class="n">SegmentAlgorithmTypeValues</span><span class="o">.</span><span class="n">AUTOMATIC</span><span class="p">,</span>
            <span class="n">algorithm_identification</span><span class="o">=</span><span class="n">algorithm_identification</span><span class="p">,</span>
            <span class="n">tracking_uid</span><span class="o">=</span><span class="n">generate_uid</span><span class="p">(),</span>
            <span class="n">tracking_id</span><span class="o">=</span><span class="s1">&#39;spydcmtk </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">segName</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">segDesc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description_segment</span><span class="p">)</span>
    <span class="c1"># Create the Segmentation instance</span>
    <span class="n">seg_dataset</span> <span class="o">=</span> <span class="n">Segmentation</span><span class="p">(</span>
        <span class="n">source_images</span><span class="o">=</span><span class="n">source_dicom_ds_list</span><span class="p">,</span>
        <span class="n">pixel_array</span><span class="o">=</span><span class="n">fullLabelMap</span><span class="p">,</span>
        <span class="n">segmentation_type</span><span class="o">=</span><span class="n">SegmentationTypeValues</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span>
        <span class="n">segment_descriptions</span><span class="o">=</span><span class="n">segDesc_list</span><span class="p">,</span>
        <span class="n">series_instance_uid</span><span class="o">=</span><span class="n">generate_uid</span><span class="p">(),</span> <span class="c1">#source_dicom_ds_list[0].SeriesInstanceUID,</span>
        <span class="n">series_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">sop_instance_uid</span><span class="o">=</span><span class="n">generate_uid</span><span class="p">(),</span> <span class="c1">#source_dicom_ds_list[0].SOPInstanceUID,</span>
        <span class="n">instance_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">manufacturer</span><span class="o">=</span><span class="s1">&#39;Manufacturer&#39;</span><span class="p">,</span>
        <span class="n">manufacturer_model_name</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span>
        <span class="n">software_versions</span><span class="o">=</span><span class="s1">&#39;v1&#39;</span><span class="p">,</span>
        <span class="n">device_serial_number</span><span class="o">=</span><span class="s1">&#39;Device XYZ&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dcmSegFileOut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seg_dataset</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">dcmSegFileOut</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">dcmSegFileOut</span>
    <span class="k">return</span> <span class="n">seg_dataset</span></div>



<div class="viewcode-block" id="getDcmSeg_meta_depreciated">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.getDcmSeg_meta_depreciated">[docs]</a>
<span class="k">def</span> <span class="nf">getDcmSeg_meta_depreciated</span><span class="p">(</span><span class="n">dcmseg</span><span class="p">):</span>
    <span class="n">sliceThick</span> <span class="o">=</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">SharedFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SliceThickness</span>
    <span class="n">pixSpace</span> <span class="o">=</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">SharedFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelSpacing</span>
    <span class="n">ffgs</span> <span class="o">=</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span>
    <span class="n">ipp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">PlanePositionSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ImagePositionPatient</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">]</span>
    <span class="n">oo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ipp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">normalVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ipp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">oo</span> 
    <span class="n">normalVector</span> <span class="o">=</span> <span class="n">normalVector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normalVector</span><span class="p">)</span>
    <span class="n">oo</span> <span class="o">=</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PlanePositionSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ImagePositionPatient</span>
    <span class="n">iop</span> <span class="o">=</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">SharedFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PlaneOrientationSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ImageOrientationPatient</span>
    <span class="n">seg_data</span> <span class="o">=</span> <span class="n">dcmseg</span><span class="o">.</span><span class="n">pixel_array</span>
    <span class="n">seg_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">seg_data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Origin&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">oo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">oo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">0.001</span><span class="p">],</span> 
            <span class="s2">&quot;Spacing&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pixSpace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">pixSpace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">sliceThick</span><span class="o">*</span><span class="mf">0.001</span><span class="p">],</span>
            <span class="s2">&quot;Dimensions&quot;</span><span class="p">:</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;ImageOrientationPatient&quot;</span><span class="p">:</span> <span class="n">iop</span><span class="p">,</span> 
            <span class="s2">&quot;SliceVector&quot;</span><span class="p">:</span> <span class="n">normalVector</span>   
            <span class="p">}</span></div>



<span class="c1"># def dicom_seg_to_vtk_depreciated(dicom_seg_path, vtk_output_path, TRUE_ORIENTATION=False):</span>
<span class="c1">#     ds = dicom.dcmread(dicom_seg_path)</span>
<span class="c1">#     patMeta = PatientMeta()</span>
<span class="c1">#     patMeta.initFromDicomSeg(ds)</span>
<span class="c1">#     seg_data = ds.pixel_array</span>
<span class="c1">#     seg_data = np.transpose(seg_data, axes=[2,1,0])</span>
<span class="c1">#     image_data = vtk.vtkImageData()</span>
<span class="c1">#     image_data.SetOrigin(patMeta.Origin)</span>
<span class="c1">#     image_data.SetDimensions(patMeta.Dimensions)</span>
<span class="c1">#     image_data.SetSpacing(patMeta.Spacing)</span>
<span class="c1">#     vtk_array = numpy_support.numpy_to_vtk(num_array=seg_data.flatten(&#39;F&#39;), deep=True, array_type=vtk.VTK_UNSIGNED_CHAR)</span>
<span class="c1">#     image_data.GetPointData().SetScalars(vtk_array)</span>
<span class="c1">#     if TRUE_ORIENTATION:</span>
<span class="c1">#         fIO.writeVTS(_vti2vts(image_data, patMeta), vtk_output_path)</span>
<span class="c1">#     else:</span>
<span class="c1">#         fIO.writeVTI(image_data, vtk_output_path)</span>
<span class="c1">#     return vtk_output_path</span>


<div class="viewcode-block" id="NoVtkError">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.NoVtkError">[docs]</a>
<span class="k">class</span> <span class="nc">NoVtkError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; NoVtkError</span>
<span class="sd">            If VTK import fails &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;NoVtkError: VTK not found. Run: &quot;pip install vtk&quot;&#39;</span></div>



<span class="c1"># ===================================================================================================</span>
<span class="c1"># ===================================================================================================</span>



<span class="c1"># =========================================================================</span>
<span class="c1"># =========================================================================</span>
<span class="c1">## HELPFUL FILTERS</span>
<span class="c1"># =========================================================================</span>
<div class="viewcode-block" id="vtkfilterFlipImageData">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.vtkfilterFlipImageData">[docs]</a>
<span class="k">def</span> <span class="nf">vtkfilterFlipImageData</span><span class="p">(</span><span class="n">vtiObj</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="n">flipper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageFlip</span><span class="p">()</span>
    <span class="n">flipper</span><span class="o">.</span><span class="n">SetFilteredAxes</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">flipper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">vtiObj</span><span class="p">)</span>
    <span class="n">flipper</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flipper</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span></div>



<div class="viewcode-block" id="addFieldDataFromDcmDataSet">
<a class="viewcode-back" href="../../spydcmtk.html#spydcmtk.dcmVTKTK.addFieldDataFromDcmDataSet">[docs]</a>
<span class="k">def</span> <span class="nf">addFieldDataFromDcmDataSet</span><span class="p">(</span><span class="n">vtkObj</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">tagsDict</span> <span class="o">=</span> <span class="n">dcmTools</span><span class="o">.</span><span class="n">getDicomTagsDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">iTag</span> <span class="ow">in</span> <span class="n">tagsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">iTag</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dicom</span><span class="o">.</span><span class="n">multival</span><span class="o">.</span><span class="n">MultiValue</span><span class="p">,</span> <span class="n">dicom</span><span class="o">.</span><span class="n">valuerep</span><span class="o">.</span><span class="n">DSfloat</span><span class="p">,</span> <span class="n">dicom</span><span class="o">.</span><span class="n">valuerep</span><span class="o">.</span><span class="n">IS</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tagArray</span> <span class="o">=</span> <span class="n">numpy_support</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="c1"># multivalue - but prob strings</span>
                    <span class="n">tagArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStringArray</span><span class="p">()</span>
                    <span class="n">tagArray</span><span class="o">.</span><span class="n">SetNumberOfValues</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span>
                        <span class="n">tagArray</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">k1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tagArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStringArray</span><span class="p">()</span>
                <span class="n">tagArray</span><span class="o">.</span><span class="n">SetNumberOfValues</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tagArray</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="n">tagArray</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">iTag</span><span class="p">)</span>
            <span class="n">vtkObj</span><span class="o">.</span><span class="n">GetFieldData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">tagArray</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># tag not found</span>
    <span class="k">for</span> <span class="n">iTag</span> <span class="ow">in</span> <span class="n">extra_tags</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">extra_tags</span><span class="p">[</span><span class="n">iTag</span><span class="p">]</span>
        <span class="n">tagArray</span> <span class="o">=</span> <span class="n">numpy_support</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="n">tagArray</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">iTag</span><span class="p">)</span>
        <span class="n">vtkObj</span><span class="o">.</span><span class="n">GetFieldData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">tagArray</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Fraser M. Callaghan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>